<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AI Code Explainer</title>

    <!-- CSRF -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            margin: 0;
            height: 100vh;
            background: #0f1115;
            color: #cbd5e1;
            font-family: system-ui, sans-serif;
        }

        /* Top bar */
        .topbar {
            height: 56px;
            background: #0b0d11;
            border-bottom: 1px solid #1f2937;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .main {
            height: calc(100vh - 56px);
        }

        /* Panels */
        .panel {
            height: 100%;
            padding: 16px;
            border-right: 1px solid #1f2937;
            display: flex;
            flex-direction: column;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 34px;
            margin-bottom: 8px;
        }

        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }


        select {
            background: #020617;
            border: 1px solid #1f2937;
            color: #cbd5e1;
        }

        select:focus {
            border-color: #22c55e;
            box-shadow: none;
        }

        .btn-explain {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: #022c22;
            font-weight: 600;
        }

        .btn-explain:hover {
            opacity: 0.9;
        }

        /* Editor */
        .editor-wrapper {
            display: flex;
            flex: 1;
            border: 1px solid #1f2937;
            background: #020617;
            font-family: monospace;
            font-size: 14px;
            overflow: hidden;
        }

        .line-numbers {
            background: #020617;
            color: #64748b;
            padding: 14px 10px;
            text-align: right;
            user-select: none;
            border-right: 1px solid #1f2937;
            min-width: 50px;
            line-height: 1.6;
            overflow: hidden;
        }

        .editor {
            flex: 1;
            padding: 14px;
            border: none;
            resize: none;
            background: transparent;
            color: #cbd5e1;
            line-height: 1.6;
            overflow: auto;
        }

        .editor:focus {
            outline: none;
        }

        /* Output */
        .output-box {
            flex: 1;
            background: #020617;
            border: 1px solid #1f2937;
            padding: 14px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Markdown */
        .output-box h1,
        .output-box h2,
        .output-box h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 600;
        }

        .output-box p,
        .output-box li {
            color: #cbd5e1;
            margin-bottom: 8px;
        }

        .output-box ul {
            padding-left: 20px;
        }

        .output-box pre {
            background: #020617;
            border: 1px solid #1e293b;
            padding: 14px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 16px;
        }

        .output-box code {
            font-family: monospace;
            color: #e2e8f0;
        }

        /* Copy buttons */
        .code-wrapper {
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #020617;
            border: 1px solid #1f2937;
            color: #94a3b8;
            font-size: 13px;
            padding: 4px 6px;
            border-radius: 6px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #16a34a;
            color: #022c22;
        }

        .editor-container,
        .output-container {
            position: relative;
        }

        /* Inside copy button */
        .copy-inside {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #020617;
            border: 1px solid #1f2937;
            color: #94a3b8;
            font-size: 13px;
            padding: 4px 6px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 10;
        }

        .copy-inside:hover {
            background: #16a34a;
            color: #022c22;
        }

        .chat-message {
            margin-bottom: 18px;
        }

        .chat-user {
            background: #020617;
            border: 1px solid #1f2937;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            color: #cbd5e1;
            white-space: pre-wrap;
        }

        .chat-ai {
            background: #0b1220;
            border: 1px solid #1e293b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
        }

        /* Chat alignment */
.chat-message {
    display: flex;
    flex-direction: column;
}

.chat-user {
    align-self: flex-end;
    max-width: 85%;
    background: linear-gradient(135deg, #1e293b, #020617);
    border: 1px solid #334155;
}

.chat-ai {
    align-self: flex-start;
    max-width: 85%;
    background: #0b1220;
    border: 1px solid #1e293b;
}

/* Language badge */
.lang-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 999px;
    margin-bottom: 6px;
    background: #020617;
    border: 1px solid #1f2937;
    color: #22c55e;
}

/* Chat animation */
.fade-in {
    animation: fadeIn 0.25s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

    </style>
</head>

<body>

    <!-- Top Bar -->
    <div class="topbar">
        AI Code Explainer
    </div>

    <!-- Main -->
    <div class="container-fluid main">
        <div class="row h-100">

            <!-- LEFT: Editor -->
            <div class="col-md-6 panel">


                <div class="controls">
                    <!-- LEFT -->
                    <div class="panel-title">Code Editor</div>

                    <!-- RIGHT -->
                    <div class="controls-right">
                        <select id="language" class="form-select form-select-sm w-auto">
                            <option value="sql">SQL</option>
                            <option value="python">Python</option>
                            <option value="php">PHP</option>
                        </select>

                        <button class="btn btn-explain btn-sm px-3" onclick="explainCode()">
                            Explain
                        </button>

                        <button class="btn btn-sm btn-outline-secondary" onclick="copyRequest()"
                            title="Copy Your Query">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                </div>


                <div class="editor-wrapper editor-container">
                    <button class="d-none copy-inside" onclick="copyRequest()" title="Copy code">
                        <i class="fa-regular fa-copy"></i>
                    </button>

                    <div class="line-numbers" id="lineNumbers">1</div>
                    <textarea id="code" class="editor" placeholder="Paste your code here..."
                        oninput="updateLineNumbers()" onscroll="syncScroll()"></textarea>
                </div>

            </div>

            <!-- RIGHT: Output -->
            <div class="col-md-6 panel">
                <div class="panel-header">
                    <div class="panel-title">AI Explanation</div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyFullResponse()" title="Copy response">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                </div>

                <div class="output-box output-container">
                    <button class="d-none copy-inside" onclick="copyFullResponse()" title="Copy Response">
                        <i class="fa-regular fa-copy"></i>
                    </button>

                    <!-- ðŸ‘‡ THIS is the ONLY thing JS will touch -->
                    <div id="aiResponse">
                        <span style="color: #6e747c">Your explanation will appear here... </span>
                    </div>
                </div>


            </div>

        </div>
    </div>

    <script>
        const codeArea = document.getElementById("code");
        const lineNumbers = document.getElementById("lineNumbers");
        const output = document.getElementById("aiResponse");


        function updateLineNumbers() {
            const lines = codeArea.value.split("\n").length;
            let nums = "";
            for (let i = 1; i <= lines; i++) nums += i + "\n";
            lineNumbers.innerText = nums;
        }

        function syncScroll() {
            lineNumbers.scrollTop = codeArea.scrollTop;
        }

        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute("content");
        }

        async function explainCode() {
            const code = codeArea.value.trim();
            const language = document.getElementById("language").value;

            if (!code) {
                alert("Please paste some code first.");
                return;
            }

            // âœ… 1. Add USER message
            addUserMessage(code, language);



            // âœ… 2. Add temporary AI loading bubble
            const loadingWrapper = document.createElement("div");
            loadingWrapper.className = "chat-message";
            loadingWrapper.innerHTML = `
                <div class="chat-ai" style="opacity:0.7">
                    Analyzing code...
                </div>
            `;
            output.appendChild(loadingWrapper);
            output.scrollTop = output.scrollHeight;

            try {
                const response = await fetch("/chat/explain/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({ code, language })
                });

                const data = await response.json();

                // remove loading bubble
                loadingWrapper.remove();

                if (data.explanation) {
                    renderAIResponse(data.explanation);
                } else {
                    renderAIResponse("Error: " + (data.error || "Unexpected server response"));
                }

            } catch (e) {
                loadingWrapper.remove();
                renderAIResponse("Error connecting to AI service.");
            }
        }


        // function renderAIResponse(text) {
        //     output.innerHTML = marked.parse(text);

        //     const codeBlocks = output.querySelectorAll("pre");
        //     codeBlocks.forEach((block) => {
        //         const wrapper = document.createElement("div");
        //         wrapper.className = "code-wrapper";

        //         const btn = document.createElement("button");
        //         btn.className = "copy-btn";
        //         // btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
        //         btn.onclick = () => copyCode(block.innerText);

        //         block.parentNode.insertBefore(wrapper, block);
        //         wrapper.appendChild(btn);
        //         wrapper.appendChild(block);
        //     });
        // }

        // function renderAIResponse(text) {
        //     const wrapper = document.createElement("div");
        //     wrapper.className = "chat-message";

        //     const aiBox = document.createElement("div");
        //     aiBox.className = "chat-ai";
        //     aiBox.innerHTML = marked.parse(text);

        //     wrapper.appendChild(aiBox);
        //     output.appendChild(wrapper);

        //     // Copy buttons for code blocks
        //     const codeBlocks = aiBox.querySelectorAll("pre");
        //     codeBlocks.forEach((block) => {
        //         const container = document.createElement("div");
        //         container.className = "code-wrapper";

        //         const btn = document.createElement("button");
        //         btn.className = "copy-btn";
        //         btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
        //         btn.onclick = () => copyCode(block.innerText);

        //         block.parentNode.insertBefore(container, block);
        //         container.appendChild(btn);
        //         container.appendChild(block);
        //     });

        //     output.scrollTop = output.scrollHeight;
        // }

        function renderAIResponse(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "chat-message fade-in";

            const aiBox = document.createElement("div");
            aiBox.className = "chat-ai";
            wrapper.appendChild(aiBox);
            output.appendChild(wrapper);

            typeMarkdown(aiBox, text);
        }

        function typeMarkdown(element, markdownText) {
            let i = 0;
            const speed = 8; // typing speed (lower = faster)
            let buffer = "";

            function type() {
                if (i < markdownText.length) {
                    buffer += markdownText[i];
                    element.innerHTML = marked.parse(buffer);
                    i++;
                    output.scrollTop = output.scrollHeight;
                    setTimeout(type, speed);
                } else {
                    attachCopyButtons(element);
                }
            }
            type();
        }


        function attachCopyButtons(container) {
            const codeBlocks = container.querySelectorAll("pre");

            codeBlocks.forEach((block) => {
                const wrapper = document.createElement("div");
                wrapper.className = "code-wrapper";

                const btn = document.createElement("button");
                btn.className = "copy-btn";
                btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
                btn.onclick = () => copyCode(block.innerText);

                block.parentNode.insertBefore(wrapper, block);
                wrapper.appendChild(btn);
                wrapper.appendChild(block);
            });
        }



        function copyCode(text) {
            navigator.clipboard.writeText(text);
        }

        function copyFullResponse() {
            navigator.clipboard.writeText(output.innerText);
        }

        function copyRequest() {
            navigator.clipboard.writeText(codeArea.value);
        }
        function addUserMessage(code, language) {
            const wrapper = document.createElement("div");
            wrapper.className = "chat-message fade-in";

            wrapper.innerHTML = `
                <div class="chat-user">
                    <span class="lang-badge">${language.toUpperCase()}</span>
                    <pre style="margin:0; white-space:pre-wrap;">${code}</pre>
                </div>
            `;

            output.appendChild(wrapper);
            output.scrollTop = output.scrollHeight;
        }


    </script>

</body>

</html>